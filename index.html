<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PJ-ECC | Secure System</title>
    
    <script src="security-engine.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --pj-orange: #FF6A00; --pj-red: #FF3131; --bg-dark: #050505; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg-dark); color: #fff; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }

        /* Security Shield */
        .security-lock { filter: brightness(0) blur(50px) !important; pointer-events: none !important; }
        #shield-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; padding: 25px; background: rgba(0,0,0,0.98); border: 2px solid var(--pj-red); border-radius: 20px; z-index: 10000; display: none; text-align: center; box-shadow: 0 0 40px var(--pj-red); }

        .container { background: rgba(15, 15, 15, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255,106,0,0.1); border-radius: 40px; padding: 25px; width: 90%; max-width: 400px; text-align: center; }
        .logo-main { font-family: 'Orbitron'; font-size: 2.5em; color: var(--pj-orange); margin: 10px 0; }

        /* --- Scanner Fix --- */
        .scanner-wrapper { position: relative; width: 100%; aspect-ratio: 1/1; border-radius: 30px; overflow: hidden; border: 2px solid var(--pj-orange); background: #000; }
        #reader { width: 100% !important; height: 100% !important; border: none !important; }
        #reader __qr_region_canvas__ { display: none !important; } /* Hide internal library canvas */
        
        .scan-line { position: absolute; top: 10%; left: 0; width: 100%; height: 3px; background: var(--pj-orange); box-shadow: 0 0 20px var(--pj-orange); animation: scan-move 2s infinite linear; z-index: 100; pointer-events: none; }
        @keyframes scan-move { 0% { top: 10%; } 100% { top: 90%; } }

        .luxury-card { position: relative; width: 100%; min-height: 480px; background: rgba(255,255,255,0.03); border-radius: 30px; margin-top: 20px; display: flex; flex-direction: column; transition: 0.4s; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
        .profile-frame { width: 110px; height: 110px; margin: 20px auto; border-radius: 20%; background: linear-gradient(135deg, var(--pj-orange), transparent); padding: 5px; }
        .profile-img { width: 100%; height: 100%; object-fit: cover; border-radius: 15%; }

        .btn { width: 100%; height: 50px; border-radius: 12px; border: none; font-weight: 900; text-transform: uppercase; cursor: pointer; margin-top: 12px; font-size: 0.8em; }
        .btn-primary { background: var(--pj-orange); color: #000; }
        .btn-secondary { background: rgba(255,255,255,0.05); color: #fff; border: 1px solid rgba(255,255,255,0.1); }
        .btn-danger { background: var(--pj-red); color: #fff; }
        .hidden { display: none !important; }
        .input-field { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; background: #000; border: 1px solid #333; color: #fff; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="shield-overlay">
        <h2 style="color: var(--pj-red); font-family: 'Orbitron'; margin:0;">⚠️ SECURITY ALERT</h2>
        <p style="color: #fff; font-size: 0.85em; margin-top:15px;">PJ company not approved screenshot and screen recording for security tight.</p>
    </div>

    <div class="container" id="main-app">
        <div id="view-home">
            <h1 class="logo-main">PJ-ECC</h1>
            <p style="font-size: 0.6em; letter-spacing: 5px; opacity:0.5;">PREMIUM ACCESS</p>
            <button onclick="switchView('view-scanner'); startScanning();" class="btn btn-primary">START SECURE SCAN</button>
            <button onclick="document.getElementById('gallery-input').click()" class="btn btn-secondary">SCAN FROM GALLERY</button>
            <input type="file" id="gallery-input" accept="image/*" class="hidden" onchange="scanFromGallery(event)">
            <button onclick="switchView('view-login')" class="btn btn-secondary" style="border:none; opacity:0.4;">ADMIN</button>
        </div>

        <div id="view-login" class="hidden">
            <h2 class="logo-main" style="font-size: 1.5em;">GATEWAY</h2>
            <input type="password" id="adminPass" class="input-field" placeholder="SECURE KEY">
            <button onclick="checkAdmin()" class="btn btn-primary">VERIFY</button>
            <button onclick="switchView('view-home')" class="btn btn-secondary">BACK</button>
        </div>

        <div id="view-admin" class="hidden">
            <h2 class="logo-main" style="font-size: 1.5em;">MAKER</h2>
            <input type="file" id="mPhoto" class="hidden" onchange="previewAdminPhoto(event)">
            <button onclick="document.getElementById('mPhoto').click()" class="btn btn-secondary" id="photo-status">UPLOAD PHOTO</button>
            <input type="text" id="mName" class="input-field" placeholder="NAME">
            <input type="text" id="mAddr" class="input-field" placeholder="ADDRESS">
            <button onclick="generateLuxuryQR()" class="btn btn-primary">GENERATE TOKEN</button>
            <div id="qr-result" class="hidden" style="margin-top:20px;">
                <div id="qr-wrap" style="background:#fff; padding:15px; border-radius:20px; display:inline-block;"><div id="qrcode"></div></div>
                <button onclick="saveQR()" class="btn btn-danger">DOWNLOAD TOKEN</button>
            </div>
            <button onclick="location.reload()" class="btn btn-secondary">HOME</button>
        </div>

        <div id="view-scanner" class="hidden">
            <div class="scanner-wrapper">
                <div id="reader"></div>
                <div class="scan-line"></div>
            </div>
            <button onclick="location.reload()" class="btn btn-secondary">CANCEL</button>
        </div>

        <div id="view-card" class="hidden">
            <div class="luxury-card" id="final-card">
                <div style="padding:15px; border-bottom:1px solid rgba(255,106,0,0.2);"><h2 style="font-size:1em; margin:0;">PJ-ECC OFFICIAL</h2></div>
                <div class="profile-frame"><img id="resPhoto" class="profile-img"></div>
                <div style="text-align:left; padding:0 25px;">
                    <small style="opacity:0.5;">PERSONNEL NAME</small>
                    <p id="resName" style="color:var(--pj-orange); font-weight:bold; margin:5px 0 15px;">--</p>
                    <small style="opacity:0.5;">OFFICIAL ADDRESS</small>
                    <p id="resAddr" style="font-size:0.8em; margin:5px 0;">--</p>
                </div>
            </div>
            <button onclick="location.reload()" class="btn btn-primary">CLOSE ACCESS</button>
        </div>

        <div id="view-error" class="hidden">
            <h2 style="color:var(--pj-red);">ACCESS DENIED</h2>
            <p>Invalid PJ-ECC Token.</p>
            <button onclick="location.reload()" class="btn btn-danger">TRY AGAIN</button>
        </div>
    </div>

    <script>
        let scanner;
        let adminPhotoBase64 = "";

        function applySecurity(lock) {
            const targets = [document.getElementById('final-card'), document.getElementById('qr-wrap')];
            const overlay = document.getElementById('shield-overlay');
            targets.forEach(el => { if(el) lock ? el.classList.add('security-lock') : el.classList.remove('security-lock'); });
            overlay.style.display = lock ? "block" : "none";
        }

        window.onblur = () => applySecurity(true);
        window.onfocus = () => applySecurity(false);

        function switchView(id) {
            document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function checkAdmin() {
            if(document.getElementById('adminPass').value === "sonu@jeet") switchView('view-admin');
            else switchView('view-error');
        }

        function previewAdminPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 80; canvas.height = 80;
                    ctx.drawImage(img, 0, 0, 80, 80);
                    adminPhotoBase64 = canvas.toDataURL('image/jpeg', 0.6);
                    document.getElementById('photo-status').innerText = "PHOTO ATTACHED ✅";
                };
            };
            reader.readAsDataURL(file);
        }

        async function startScanning() {
            scanner = new Html5Qrcode("reader");
            const config = { fps: 25, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
            try {
                await scanner.start({ facingMode: "environment" }, config, (text) => {
                    scanner.stop().then(() => processToken(text));
                });
            } catch (err) { console.error(err); }
        }

        function scanFromGallery(event) {
            const file = event.target.files[0];
            if (!file) return;
            const tempScanner = new Html5Qrcode("reader");
            tempScanner.scanFile(file, true)
                .then(text => processToken(text))
                .catch(() => switchView('view-error'));
        }

        function processToken(data) {
            try {
                if(!data.startsWith("SEC|")) throw new Error("Invalid");
                const encrypted = data.split("SEC|")[1];
                const decrypted = SecurityEngine.secureDecrypt(encrypted);
                const user = JSON.parse(decrypted);
                
                switchView('view-card');
                document.getElementById('resName').innerText = user.n;
                document.getElementById('resAddr').innerText = user.a;
                document.getElementById('resPhoto').src = user.p;
            } catch(e) { switchView('view-error'); }
        }

        function generateLuxuryQR() {
            const n = document.getElementById('mName').value;
            const a = document.getElementById('mAddr').value;
            if(!n || !adminPhotoBase64) return alert("Missing Info");
            
            const qrd = document.getElementById('qrcode');
            qrd.innerHTML = "";
            const raw = JSON.stringify({ n, a, p: adminPhotoBase64 });
            const encrypted = btoa(raw).split('').reverse().join('');
            
            new QRCode(qrd, { text: "SEC|" + encrypted, width: 200, height: 200 });
            document.getElementById('qr-result').classList.remove('hidden');
        }

        function saveQR() {
            html2canvas(document.getElementById('qr-wrap')).then(canvas => {
                const link = document.createElement('a');
                link.download = 'PJ_TOKEN.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }
    </script>
</body>
</html>
